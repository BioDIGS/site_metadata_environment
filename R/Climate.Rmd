---
title: "Get Climate Properties"
author: "Ava Hoffman"
date: "2025-12-08"
---

```{r}
library(tidyverse) # %>% and other functions, need lubridate, dplyr
library(terra)
library(ncdf4)
```
---

The CRU TS v. 4.09 is from: https://crudata.uea.ac.uk/cru/data/hrg/ (version 4.09) and has a paper here: https://www.nature.com/articles/s41597-020-0453-3

Read in weather data - avg precip, vapor pressure (humidity), cloud cover, air temperature
Create code to take data for nearest day of collection (some day in 2023)

vapor pressure (hPa) - vap: https://crudata.uea.ac.uk/cru/data/hrg/cru_ts_4.09/cruts.2503051245.v4.09/vap/
precipication (mm/month) - pre: https://crudata.uea.ac.uk/cru/data/hrg/cru_ts_4.09/cruts.2503051245.v4.09/pre/
cloud cover (percent) - cld: https://crudata.uea.ac.uk/cru/data/hrg/cru_ts_4.09/cruts.2503051245.v4.09/cld/
mean near-surface temperature (Celcius) - tmp: https://crudata.uea.ac.uk/cru/data/hrg/cru_ts_4.09/cruts.2503051245.v4.09/tmp/
tmx
tmn
Diurnal Temperature Range - dtr: 
wet
Ground frost frequency (days) - frs: https://crudata.uea.ac.uk/cru/data/hrg/cru_ts_4.09/cruts.2503051245.v4.09/frs/
pet


# Get the climate data for the soil sites

```{r}
github_stem <- "https://raw.githubusercontent.com/FredHutch/GDSCNsoilsites/refs/heads/main/data/snapshots/"

# Get soil data
snapshot <- "BioDIGS_soil_20251111.csv"
soil_data <- 
  read.csv(paste0(github_stem, snapshot)) %>% distinct(site_id, sample_id, collection_date)
```

Prepare data to extract climate information from external data

```{r}
# Read these in to get GPS coordinates
snapshot <- "BioDIGS_sites_20251111.csv"
sites_data <- read.csv(paste0(github_stem, snapshot)) %>% select(site_id, gps)

soil_dates <- 
  soil_data %>% 
  left_join(sites_data) %>% 
  tidyr::separate(gps, into = c("lat", "lon"), sep = ", ") %>% 
  mutate(across(c(lat, lon), as.numeric)) %>% 
  mutate(collection_date = lubridate::mdy(collection_date))
str(soil_dates)
```

Create some functions to find the appropriate data points

```{r}
# Function to clean up CRU data
get_cru_dat <- function(file_dir, var_) {
  # Read in data - note that you can view metadata when running the object in console
  nc_dat <- ncdf4::nc_open(paste0("../large_files/", file_dir))
  print(nc_dat)
  
  # Get spatiotemporal variables
  lat <- ncvar_get(nc_dat, "lat")
  lon <- ncvar_get(nc_dat, "lon")
  time <- as_date(ncvar_get(nc_dat, "time"), origin = "1900-1-1")
  
  # Get a subset of lat, lon, time to
  lat_subset <- as.vector(lat[lat < 51 &
                                lat > 23]) # Limit to roughly the USA
  lon_subset <- as.vector(lon[lon < -66 &
                                lon > -127]) # Limit to roughly the USA
  time_subset <- as_date(as.vector(time[time > as_date("2023-04-01")])) # Limit to roughly the sampling times
  
  # Get variable of interest
  the_var <- ncvar_get(nc_dat, var_)
  
  # Create full grid, flatten to data frame
  st_df <- as.matrix(expand.grid(lon = lon, lat = lat, time = time)) # Takes some time
  st_df_var <-
    data.frame(st_df, the_var = as.vector(the_var)) %>%
    mutate(lon = as.numeric(lon),
           lat = as.numeric(lat),
           time = as_date(time))
  
  # Subset by region/time, remove NAs
  st_df_var_sub <-
    st_df_var %>%
    dplyr::filter(lat %in% lat_subset, lon %in% lon_subset, time %in% time_subset) %>%
    na.omit()
  
  return(st_df_var_sub)
}

# Function that gets the closest point to the sample location / date
get_closest_point <- function(labels, latlon, date_, cru_dat, var_) {
  # Confirm data is formatted correctly
  if (is.data.frame(latlon)) {
    # Confirm column names for terra
    if ("lat" %in% colnames(latlon) &
        "lon" %in% colnames(latlon)) {
      # If any lat/lon are NA, return dummy data
      if (is.na(latlon$lat) | is.na(latlon$lon)) {
        # Create NA data
        dummy_df <- data.frame(
          site_id = labels$site_id,
          sample_id = labels$sample_id,
          lon = latlon$lon,
          lat = latlon$lat,
          collection_date = date_,
          lon_cru = NA,
          lat_cru = NA,
          time = NA,
          the_var = NA
        )
        colnames(dummy_df)[9] <- var_
        return(dummy_df)
        
      } else {
        # Convert to terra object
        vals_terra <- terra::vect(latlon, crs = "+proj=longlat +datum=WGS84")
        cru_dat_terra <- terra::vect(cru_dat[, 1:2], crs = "+proj=longlat +datum=WGS84")
        
        # Calculate nearest observation
        latlon_dist <- cbind(cru_dat, lldist = terra::distance(cru_dat_terra, vals_terra)) # Geospatial distance
        latlon_dist$timediff <- abs(as_date(latlon_dist$time) - as_date(date_)) # absolute value of date difference
        
        # Filter for minimum distance
        var_final <-
          latlon_dist %>%
          filter(lldist == min(lldist), timediff == min(timediff)) %>%
          dplyr::select(lon, lat, time, the_var)
        var_final <- cbind(labels, latlon, date_, var_final)
        colnames(var_final) <- c(
          "site_id",
          "sample_id",
          "lon",
          "lat",
          "collection_date",
          "lon_cru",
          "lat_cru",
          "time",
          var_
        )
        return(var_final
        )
      }
    }
  }
}
```

Vapor pressure:

```{r}
vap_dat <- get_cru_dat(file_dir = "cru_ts/cru_ts4.09.2021.2024.vap.dat.nc", var_ = "vap")
vap_out <- pmap_dfr(
  soil_dates,
  ~ get_closest_point(
    labels = data.frame(site_id = ..1, sample_id = ..2),
    latlon = data.frame(lat = ..4, lon = ..5),
    date_ = ..3,
    cru_dat = vap_dat,
    var_ = "vap"
  )
)
write_csv(vap_out, "data/cru_vap.csv")
```

Precipitation:

```{r}
pre_dat <- get_cru_dat(file_dir = "cru_ts/cru_ts4.09.2021.2024.pre.dat.nc", var_ = "pre")
pre_out <- pmap_dfr(
  soil_dates,
  ~ get_closest_point(
    labels = data.frame(site_id = ..1, sample_id = ..2),
    latlon = data.frame(lat = ..4, lon = ..5),
    date_ = ..3,
    cru_dat = pre_dat,
    var_ = "pre"
  )
)
write_csv(pre_out, "data/cru_pre.csv")
```

Precipitation:

```{r}
cld_dat <- get_cru_dat(file_dir = "cru_ts/cru_ts4.09.2021.2024.cld.dat.nc", var_ = "cld")
cld_out <- pmap_dfr(
  soil_dates,
  ~ get_closest_point(
    labels = data.frame(site_id = ..1, sample_id = ..2),
    latlon = data.frame(lat = ..4, lon = ..5),
    date_ = ..3,
    cru_dat = cld_dat,
    var_ = "cld"
  )
)
write_csv(cld_out, "data/cru_cld.csv")
```

Temperature:

```{r}
tmp_dat <- get_cru_dat(file_dir = "cru_ts/cru_ts4.09.2021.2024.tmp.dat.nc", var_ = "tmp")
tmp_out <- pmap_dfr(
  soil_dates,
  ~ get_closest_point(
    labels = data.frame(site_id = ..1, sample_id = ..2),
    latlon = data.frame(lat = ..4, lon = ..5),
    date_ = ..3,
    cru_dat = tmp_dat,
    var_ = "tmp"
  )
)
write_csv(tmp_out, "data/cru_tmp.csv")
```

Ground frost frequency:

```{r}
frs_dat <- get_cru_dat(file_dir = "cru_ts/cru_ts4.09.2021.2024.frs.dat.nc", var_ = "frs")
frs_out <- pmap_dfr(
  soil_dates,
  ~ get_closest_point(
    labels = data.frame(site_id = ..1, sample_id = ..2),
    latlon = data.frame(lat = ..4, lon = ..5),
    date_ = ..3,
    cru_dat = frs_dat,
    var_ = "frs"
  )
)
write_csv(frs_out, "data/cru_frs.csv")
```