---
title: "Get Soil Properties - NRCS gSSURGO"
author: "Ava Hoffman"
date: "2025-11-03"
---

```{r}
library(tidyverse) # %>% and other functions
library(sf)
```
---

The following come from Natural Resource Conservation Service, US Department of Agriculture. Gridded SSURGO (gSSURGO) is similar to the standard USDA-NRCS Soil Survey Geographic (SSURGO) Database product but in the format of an Environmental Systems Research Institute, Inc. (ESRIÂ®) file geodatabase.

Landing page: https://www.nrcs.usda.gov/resources/data-and-reports/gridded-soil-survey-geographic-gssurgo-database 

Data can be downloaded by state here: https://nrcs.app.box.com/v/soils/folder/233398887779

There is a fair amount of work to determine which datasets and metadata to use. These have been helpful:

Data dictionary: https://www.nrcs.usda.gov/sites/default/files/2022-08/SSURGO-Metadata-Table-Column-Descriptions-Report.pdf
Column types and units: https://www.nrcs.usda.gov/sites/default/files/2022-08/SSURGO-Metadata-Tables-and-Columns-Report.pdf
Manually checking data: https://websoilsurvey.nrcs.usda.gov/app/WebSoilSurvey.aspx 

The following assumes the user has a directory at `../large_files/` containing the large files.

## Load data

```{r}
snapshot <- "BioDIGS_sites_20251111.csv"

full_data <-
  read.csv(
    paste0(
      "https://raw.githubusercontent.com/FredHutch/GDSCNsoilsites/refs/heads/main/data/snapshots/",
      snapshot
    )
  )
```

## Prepare data

```{r}
full_data <- tidyr::separate(full_data, gps, into = c("lat", "lon"), sep = ", ")
full_data$lat <- as.numeric(full_data$lat)
full_data$lon <- as.numeric(full_data$lon)

full_data <- full_data %>% 
  mutate(origin = case_when(
    site_name == "Augusta, GA" ~ "Augusta, GA",
    site_name == "Keysville, GA" ~ "Keysville, GA",
    TRUE ~ origin
  ))
```

## Get state in the US

```{r}
# Data is quite large so this saves some time
full_data <- tidyr::separate(
  full_data,
  origin,
  into = c("city", "state"),
  sep = ", ",
  remove = FALSE
)
```

## Get soil survey data

```{r}
# Prepare coordinates DF
coords_df <- data.frame(
  state = full_data$state,
  site_name = full_data$site_name,
  lat = full_data$lat,
  lon = full_data$lon,
  Lat = full_data$lat,
  Lon = full_data$lon
)
```

```{r}
# Set up function to extract data
get_soil_survey <- function(state, coords_df) {
  # Contains polygons of soil map units (shapes)
  mapunits <- read_sf(paste0(
    "../large_files/gSSURGO_",
    state,
    ".gdb/a00000052.gdbtable"
  ))
  
  coords_df_state <- coords_df[coords_df$state == state, ]
  points_sf <- st_as_sf(coords_df_state,
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +datum=WGS84")
  points_sf <- st_transform(points_sf, st_crs(mapunits))
  points_sf_joined <- st_join(points_sf, mapunits, join = st_within) # takes a while!
  
  # Links map units to soil properties
  if (state %in% c("SC", "NJ", "ND")) {
    # New Jersey, North Dakota, and South Carolina's spatial tables are labeled a bit differently
    mapunits_components <- read_sf(paste0(
      "../large_files/gSSURGO_",
      state,
      ".gdb/a00000063.gdbtable"
    ))
  } else {
    mapunits_components <- read_sf(paste0(
      "../large_files/gSSURGO_",
      state,
      ".gdb/a00000061.gdbtable"
    ))
  }
  
  # Get the soil properties table
  soil_properties <- read_sf(paste0(
    "../large_files/gSSURGO_",
    state,
    ".gdb/a0000000f.gdbtable"
  ))
  
  points_sf_joined_soil <-
    points_sf_joined %>%
    left_join(mapunits_components, by = c("MUKEY" = "mukey")) %>%
    left_join(soil_properties, relationship = "many-to-many")
  
  soil_cleaned <- points_sf_joined_soil %>% select(
    state,
    site_name,
    lat,
    lon,
    AREASYMBOL,
    MUSYM,
    MUKEY,
    cokey,
    hzname,
    hzdept_r,
    hzdepb_r,
    sandtotal_r,
    silttotal_r,
    claytotal_r,
    om_r
  )
  
  return(soil_cleaned)
}
```

## Get Maryland Data

```{r}
soil_survey_out <- get_soil_survey("MD", coords_df)
full_data_soil_md <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "MD") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_md, "data/gSSURGO_MD.csv")
```

## Get Virginia Data

```{r}
soil_survey_out <- get_soil_survey("VA", coords_df)
full_data_soil_va <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "VA") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_va, "data/gSSURGO_VA.csv")
```

## Get North Carolina Data

```{r}
soil_survey_out <- get_soil_survey("NC", coords_df)
full_data_soil_nc <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "NC") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_nc, "data/gSSURGO_NC.csv")
```

## Get South Carolina Data

```{r}
soil_survey_out <- get_soil_survey("SC", coords_df_sc)
full_data_soil_sc <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "SC")  %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_sc, "data/gSSURGO_SC.csv")
```

## Get Colorado Data

```{r}
soil_survey_out <- get_soil_survey("CO", coords_df)
full_data_soil_co <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "CO") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_co, "data/gSSURGO_CO.csv")
```

## Get Texas Data

```{r}
soil_survey_out <- get_soil_survey("TX", coords_df)
full_data_soil_tx <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "TX") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_tx, "data/gSSURGO_TX.csv")
```

## Get California Data

```{r}
soil_survey_out <- get_soil_survey("CA", coords_df)
full_data_soil_ca <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "CA") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_ca, "data/gSSURGO_CA.csv")
```

## Get Georgia Data

```{r}
soil_survey_out <- get_soil_survey("GA", coords_df)
full_data_soil_ga <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "GA") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_ga, "data/gSSURGO_GA.csv")
```

## Get New York Data

```{r}
soil_survey_out <- get_soil_survey("NY", coords_df)
full_data_soil_ny <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "NY") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_ny, "data/gSSURGO_NY.csv")
```

## Get New Jersey Data

```{r}
soil_survey_out <- get_soil_survey("NJ", coords_df)
full_data_soil_nj <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "NJ") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_nj, "data/gSSURGO_NJ.csv")
```

## Get Minnesota Data

```{r}
soil_survey_out <- get_soil_survey("MN", coords_df)
full_data_soil_mn <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "MN") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_mn, "data/gSSURGO_MN.csv")
```

## Get Tennessee Data

```{r}
soil_survey_out <- get_soil_survey("TN", coords_df)
full_data_soil_tn <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "TN") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_tn, "data/gSSURGO_TN.csv")
```

## Get North Dakota Data

```{r}
soil_survey_out <- get_soil_survey("ND", coords_df)
full_data_soil_nd <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "ND") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_nd, "data/gSSURGO_ND.csv")
```

## Get Oklahoma Data

```{r}
soil_survey_out <- get_soil_survey("OK", coords_df)
full_data_soil_ok <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "OK") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_ok, "data/gSSURGO_OK.csv")
```

## Get Washington Data

```{r}
soil_survey_out <- get_soil_survey("WA", coords_df)
full_data_soil_wa <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "WA") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_wa, "data/gSSURGO_WA.csv")
```

## Get Pennsylvania Data

```{r}
soil_survey_out <- get_soil_survey("PA", coords_df)
full_data_soil_pa <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "PA") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_pa, "data/gSSURGO_PA.csv")
```

## Get Arizona Data

```{r}
soil_survey_out <- get_soil_survey("AZ", coords_df)
full_data_soil_az <-
  dplyr::left_join(
    full_data,
    dplyr::distinct(soil_survey_out),
    by = c("lat", "lon", "state", "site_name")
  ) %>%
  filter(state == "AZ") %>%
  filter(public_ok == TRUE)
readr::write_csv(full_data_soil_az, "data/gSSURGO_AZ.csv")
```

# Alternative data (FAO)

The following code helps find **Soil Organic Carbon** associated with each set of GPS coordinates.

Data are derived from the The Global Soil Organic Carbon (GSOC) Map v1.5 (GSOC), a product of GloSIS (Global Soil Information System) organization that is part of the Food and Agriculture Organization of the United Nations (FAO).

This data is from version 1.5, published in 2018.

Metadata/report can be found here: https://openknowledge.fao.org/server/api/core/bitstreams/c3ccec0d-fe75-49b7-9a4c-ee0a8777fed9/content

Data can be downloaded here: https://data.apps.fao.org/catalog//iso/7730e747-eb73-49c9-bfe6-84ebae718743 

Spatial scale is at 1km resolution and depth is 0-30cm. In the USA, SOC analysis method is primarily dry combustion and is derived from Natural Resource Conservation Service, US Department of Agriculture.

Sampling period: 1950-2015 
SOC analysis method: multiple methods over time - primarily dry combustion 
BD analysis method: Bulk density measured on undisturbed clods coated in saran (KSSL, 2014)
units: **tonnes/hectare**

```{r}
# Set up function to extract data
get_coord_vals <- function(latlon, tif_file) {
  file_dir <- paste0("../large_files/", tif_file)
  
  r <- terra::rast(file_dir)
  the_crs <- terra::crs(r)
  
  # Confirm data is formatted correctly
  if (is.data.frame(latlon)) {
    # Confirm column names for terra
    if ("lat" %in% colnames(latlon) &
        "lon" %in% colnames(latlon)) {
      vals <- data.frame(lon = latlon$lon, lat = latlon$lat)
      vals_terra <- terra::vect(vals, crs = "+proj=longlat", keepgeom = T)
      extracted_vals <- terra::extract(r, terra::project(vals_terra, the_crs))
      out <- cbind(vals, extracted_vals[, 2])
      colnames(out)[3] <- colnames(extracted_vals[2])
      return(out)
    }
  }
}
```

Extract SOC data:

```{r}
fao_lat_lon <- full_data %>% select(lat, lon)
GSOC <- get_coord_vals(fao_lat_lon, "GSOCmap1.5.0.tif")
readr::write_csv(GSOC, "data/FAO_GSOC.csv")
```

pH, salinity, gravel/clay content, oxygen, toxicity, water availability

```{r}
oxygen <- get_coord_vals(fao_lat_lon, "oxygen_sq4.tif")
salt <- get_coord_vals(fao_lat_lon, "salt_sq5.tif") %>% distinct()
nutrient <- get_coord_vals(fao_lat_lon, "nutrient_avail_sq1.tif") %>% distinct()
clay <- get_coord_vals(fao_lat_lon, "T_CLAY.tif") %>% distinct()
gravel <- get_coord_vals(fao_lat_lon, "T_GRAVEL.tif") %>% distinct()
sand <- get_coord_vals(fao_lat_lon, "T_SAND.tif") %>% distinct()
fao_ph <- get_coord_vals(fao_lat_lon, "T_PH_H2O.tif") %>% distinct()
awc <- get_coord_vals(fao_lat_lon, "AWC_CLASS.tif") %>% distinct()

bound_fao_data <- 
  oxygen %>% 
  left_join(salt) %>% 
  left_join(nutrient) %>% 
  left_join(clay) %>% 
  left_join(gravel) %>% 
  left_join(sand) %>% 
  left_join(fao_ph) %>% 
  left_join(awc)

readr::write_csv(bound_fao_data, "data/FAO_soil_char.csv")
```

